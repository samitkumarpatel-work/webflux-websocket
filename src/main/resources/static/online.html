<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Online</title>
    <style>
        body {
            margin-left: auto;
            margin-right: auto;
            width: 50%;
        }
        #online {
            display: flex;
            flex-direction: column;
        }
        hr {
            margin-top: 20px;
            margin-bottom: 20px;
            border: 1px solid black;
            width:50%;
            text-align:left;
            margin-left:0;
        }
        #page3__rooms {
            display: flex;
            flex-direction: row;
        }
        .page3__room {
            border-left: 1px solid black;
        }
    </style>
</head>
<body>
    <div id="online">
        <section id="page1">
            <h3>Rooms</h3>
            <div id="page1__available_rooms"></div>
            <button onclick="createRoom()">Create New Room</button>
        </section>

        <hr>

        <section id="page2">
            <h3>Join room</h3>
            <select id="page2__available_rooms">
                <option value="room1">Select a room</option>
            </select>
            <input type="text" id="page2__member_name" placeholder="Enter your Name" />
            <button onclick="joinRoom()">Join</button>
        </section>

        <hr>

        <section id="page3">
            <h3>Online Status</h3>
            <div id="page3__websocket_status"></div>
        </section>
    </div>

    <script>
        fetchRooms = () => {
            fetch("/room")
                .then(response => response.json())
                .then(data => {
                    console.log(data);
                    const rooms = data.length > 0 ? data.map(room => `<p>${room}</p>`) : ["No rooms available"]
                    document.querySelector("#page1__available_rooms").innerHTML = rooms.join("");
                    document.querySelector("#page2__available_rooms").innerHTML = data.map(room => `<option value="${room}">${room}</option>`);
                });
        }

        createRoom = () => {
            fetch("/room", {
                method: "POST",
                body: "randomRoom"
            })
            .then(response => response.json())
            .then(data => {
                console.log(data);
                fetchRooms();
            });
        }

        joinRoom = () => {
            const roomId = document.querySelector("#page2__available_rooms").value;
            const memberName = document.querySelector("#page2__member_name").value;
            fetch(`/${roomId}/member`, {
                method: "POST",
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({
                    id: memberName.toLowerCase(),
                    name: memberName
                })
            })
            .then(response => response.json())
            .then(data => establishWebSocket(roomId));
        }

        establishWebSocket = (roomId) => {
            const clientWebSocket = new WebSocket(`ws://localhost:8080/websocket-status?${roomId}`);

            clientWebSocket.onopen = function(e) {
                // clientWebSocket.send(`${memberId} is Online`);
                // events("Establish connection");
            }

            clientWebSocket.onclose = function(error) {
                // events("Closing connection");
            }

            clientWebSocket.onerror = function(error) {
                // events("An error occured");
            }

            clientWebSocket.onmessage = function(event) {
                //console.log("clientWebSocket.onmessage", clientWebSocket, event);
                events(JSON.parse(event.data));
            }
        }

        function events(responseEvent) {
            console.log(responseEvent);
            //document.querySelector("#page3__websocket_status").innerHTML += responseEvent + "<br/>";
            document.querySelector("#page3__websocket_status").innerHTML = "";
            responseEvent.map(event => {
                document.querySelector("#page3__websocket_status").innerHTML += `<p>${event.id} , ${event.name}</p>`;
            })
        }

        fetchRooms();
    </script>
</body>
</html>